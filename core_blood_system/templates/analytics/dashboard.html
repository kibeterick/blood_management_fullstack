{% extends 'base.html' %}

{% block title %}Analytics Dashboard - Blood Management System{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="page-wrapper" style="max-width: 1400px;">
        <div class="page-title">
            <i class="bi bi-graph-up text-primary"></i>
            Analytics Dashboard
        </div>
        <p class="page-subtitle">Comprehensive insights and statistics</p>

        <!-- Key Metrics -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="bi bi-people-fill text-primary" style="font-size: 2.5rem;"></i>
                        <h2 class="mt-2">{{ analytics.total_donors }}</h2>
                        <p class="text-muted mb-0">Total Donors</p>
                        <small class="text-success">+{{ analytics.new_donors_this_month }} this month</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="bi bi-file-medical text-danger" style="font-size: 2.5rem;"></i>
                        <h2 class="mt-2">{{ analytics.pending_requests }}</h2>
                        <p class="text-muted mb-0">Pending Requests</p>
                        <small class="text-warning">{{ analytics.critical_requests }} critical</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="bi bi-droplet-fill text-success" style="font-size: 2.5rem;"></i>
                        <h2 class="mt-2">{{ analytics.total_donations }}</h2>
                        <p class="text-muted mb-0">Total Donations</p>
                        <small class="text-info">{{ analytics.donations_this_month }} this month</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="bi bi-box-seam text-warning" style="font-size: 2.5rem;"></i>
                        <h2 class="mt-2">{{ analytics.total_units_donated }}</h2>
                        <p class="text-muted mb-0">Units Donated</p>
                        <small class="text-danger">{{ analytics.low_stock_items }} low stock</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 1 -->
        <div class="row mb-4">
            <div class="col-md-8 mb-3">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-graph-up"></i> Monthly Donation Trends
                    </div>
                    <div class="card-body">
                        <canvas id="monthlyTrendsChart" height="80"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-pie-chart"></i> Blood Type Distribution
                    </div>
                    <div class="card-body">
                        <canvas id="bloodTypeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inventory Status -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-box-seam"></i> Blood Inventory Status
            </div>
            <div class="card-body">
                <div class="row">
                    {% for item in analytics.inventory_status %}
                    <div class="col-md-3 mb-3">
                        <div class="card {% if item.is_low_stock %}border-danger{% endif %}">
                            <div class="card-body text-center">
                                <h3 class="text-danger">{{ item.blood_type }}</h3>
                                <h2>{{ item.units_available }}</h2>
                                <p class="text-muted mb-0">units available</p>
                                {% if item.is_low_stock %}
                                    <span class="badge bg-danger mt-2">Low Stock</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Export Button -->
        <div class="text-center">
            <a href="{% url 'export_analytics_report' %}" class="btn btn-primary btn-lg">
                <i class="bi bi-download"></i> Export Full Report (PDF)
            </a>
        </div>
    </div>
</div>

<script>
// Monthly Trends Chart
const monthlyCtx = document.getElementById('monthlyTrendsChart').getContext('2d');
const monthlyData = {{ analytics.monthly_trends|safe }};

new Chart(monthlyCtx, {
    type: 'line',
    data: {
        labels: monthlyData.map(d => d.month),
        datasets: [{
            label: 'Donations',
            data: monthlyData.map(d => d.donations),
            borderColor: '#dc3545',
            backgroundColor: 'rgba(220, 53, 69, 0.1)',
            tension: 0.4,
            fill: true
        }, {
            label: 'Units',
            data: monthlyData.map(d => d.units),
            borderColor: '#0d6efd',
            backgroundColor: 'rgba(13, 110, 253, 0.1)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                position: 'top',
            }
        },
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Blood Type Distribution Chart
const bloodTypeCtx = document.getElementById('bloodTypeChart').getContext('2d');
const bloodTypeData = {{ analytics.blood_type_distribution|safe }};

new Chart(bloodTypeCtx, {
    type: 'doughnut',
    data: {
        labels: bloodTypeData.map(d => d.blood_type),
        datasets: [{
            data: bloodTypeData.map(d => d.count),
            backgroundColor: [
                '#dc3545', '#0d6efd', '#198754', '#ffc107',
                '#6f42c1', '#20c997', '#fd7e14', '#d63384'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                position: 'bottom',
            }
        }
    }
});
</script>
{% endblock %}
